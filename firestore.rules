rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the requesting user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // USERS: Users can read/write their own data.
    // This includes their main document and any subcollections like investments.
    match /users/{userId}/{documents=**} {
      allow read, write: if isOwner(userId);
    }
    
    // USER SIGN-UP (REFERRALS): Allow a newly created user to write to another user's referral subcollection.
    // This is a specific exception needed for the referral system to work on sign-up.
    match /users/{referrerId}/referrals/{newUserId} {
        allow create: if isAuthenticated() && newUserId == request.auth.uid;
    }

    // USER STATS: Users can only read/write their own stats.
    match /userStats/{userId} {
      allow read, write: if isOwner(userId);
    }

    // EARNINGS LOG: Users can only read/write their own earnings log.
    match /earningsLog/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // PAYMENT DETAILS: Users can only read/write their own payment details.
    match /userPaymentDetails/{userId} {
        allow read, write: if isOwner(userId);
    }

    // PUBLIC DATA: Anyone can read the public investment packages, distributor tiers,
    // and commission tiers. Only admins (via backend functions) should write.
    match /silverLevelPackages/{docId} {
      allow read: if true;
      allow write: if false; // Managed by admin panel via backend function
    }
    match /distributorTiers/{docId} {
      allow read: if true;
      allow write: if false; // Managed by admin panel via backend function
    }
    match /commissionTiers/{docId} {
      allow read: if true;
      allow write: if false; // Managed by admin panel via backend function
    }

    // TRANSACTION PROOFS (DEPOSITS): Authenticated users can create them.
    // Only admins should be able to update/delete them.
    match /transactionProofs/{proofId} {
      allow create: if isAuthenticated();
      allow read: if true; // To show on live transactions feed
      allow update, delete: if false; // Managed by admin panel via backend function
    }

    // WITHDRAWAL REQUESTS: Authenticated users can create them.
    // Only admins should be able to update/delete them.
    match /withdrawalRequests/{reqId} {
      allow create: if isAuthenticated();
      allow read: if true; // To show on live transactions feed
      allow update, delete: if false; // Managed by admin panel via backend function
    }
  }
}