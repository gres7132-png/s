
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    // Checks if the requesting user is the owner of the document.
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Checks if the requesting user is an administrator.
    // This email list MUST be kept in sync with the one in `src/hooks/use-auth.tsx`
    function isAdmin() {
      return request.auth.token.email in ["gres7132@gmail.com"];
    }

    // --- User Data ---
    // Users can create/update their own profile. Admins can do anything.
    match /users/{userId} {
      // Users can manage their own profile, but cannot delete it.
      allow read, create, update: if isOwner(userId);
      // Admins can read, write, AND delete any user's profile.
      allow read, write: if isAdmin();
    }
    
    // Users can fully manage their own sub-collections. Admins can too.
    match /users/{userId}/{collection}/{docId} {
        allow read, write: if isOwner(userId) || isAdmin();
    }

    // --- User Statistics (Balances) ---
    // Critical for financial data security.
    match /userStats/{userId} {
      // Users can create their own stats doc (on signup) and read it.
      allow create, read: if isOwner(userId);
      // ONLY an admin can update a user's balance. Users cannot.
      allow update: if isAdmin();
      // Admins can read any user's stats.
      allow read: if isAdmin();
    }

    // --- User Payment Details ---
    // Users can manage their own payment details. Admins can too.
    match /userPaymentDetails/{userId} {
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // --- Platform Configuration (Packages & Tiers) ---
    // Anyone logged in can read these configurations.
    match /(silverLevelPackages|contributorTiers|commissionTiers)/{docId} {
      allow read: if request.auth != null;
      // Only admins can modify the platform's packages and tiers.
      allow write: if isAdmin();
    }
    
    // --- Transaction & Application Flows ---
    // Covers deposits, withdrawals, and contributor applications.
    match /(transactionProofs|withdrawalRequests|contributorApplications)/{docId} {
        // Any authenticated user can create a request/application.
        allow create: if request.auth != null;
        // Only the user who created it or an admin can view/update it.
        allow read, update: if isOwner(request.resource.data.userId) || isAdmin();
    }
  }
}
