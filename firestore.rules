
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Admin Configuration ---
    // This list must be kept in sync with the ADMIN_EMAILS array in the application code.
    function isAdmin() {
      return request.auth != null && request.auth.token.email in ["gres7132@gmail.com"];
    }

    // --- Publicly Readable Data ---
    // Anyone can view the investment packages and tiers.
    match /silverLevelPackages/{packageId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /contributorTiers/{tierId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /commissionTiers/{tierId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- User Data ---
    // Users can only read and write their own data.
    match /users/{userId} {
      allow read, update, create: if request.auth != null && request.auth.uid == userId;
      // Allow admins to update the hasActiveInvestment flag
      allow update: if isAdmin();
    }
    match /userStats/{userId} {
       allow read, create: if request.auth != null && request.auth.uid == userId;
       // Allow admins to update any user's stats (e.g., for balance changes)
       allow update: if isAdmin();
    }
     match /userPaymentDetails/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- User-Specific Subcollections ---
    // Users can manage their own investments.
    match /users/{userId}/investments/{investmentId} {
        allow read, create, update, delete: if request.auth != null && request.auth.uid == userId || isAdmin();
    }
    
    // --- Transaction & Request Submissions (User Actions) ---
    // Any authenticated user can create a proof or a request.
    // Only admins can update/delete them (approve/reject).
    match /transactionProofs/{proofId} {
        allow create: if request.auth != null;
        allow read, update, delete: if isAdmin();
    }
    match /withdrawalRequests/{requestId} {
        allow create: if request.auth != null;
        allow read, update, delete: if isAdmin();
    }
     match /contributorApplications/{applicationId} {
        allow create: if request.auth != null;
        allow read, update, delete: if isAdmin();
    }
  }
}
